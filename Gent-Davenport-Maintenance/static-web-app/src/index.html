<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gent Machine - Davenport Technical Support</title>
    <style>
        /* CSS Variables for branding */
        :root {
            /* Gent Machine Brand */
            --gent-blue: #00528A;
            --gent-blue-dark: #003d66;
            --gent-orange: #F3802B;
            --gent-orange-light: #fde8d9;

            /* Aidan Systems Brand */
            --aidan-blue: #0598B3;
            --aidan-light-green: #E1EFF2;

            /* Functional */
            --bg-page: #f0f0f0;
            --text-primary: #191919;
            --text-secondary: #444;
            --border-light: #d0d0d0;

            /* Typography - Shop Floor (large for readability) */
            --font-base: 20px;
            --font-large: 28px;
            --font-medium: 18px;
            --font-small: 14px;

            /* Touch Targets */
            --touch-min: 48px;
            --touch-large: 56px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, 'Segoe UI', sans-serif;
            background-color: var(--bg-page);
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: var(--font-base);
            line-height: 1.6;
        }

        header {
            background-color: var(--gent-blue);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-brand img {
            height: 50px;
            border-radius: 4px;
        }

        header h1 {
            font-size: var(--font-large);
            font-weight: 700;
        }

        header .subtitle {
            font-size: var(--font-medium);
            opacity: 0.9;
        }

        .header-right {
            margin-left: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .reasoning-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .reasoning-toggle label {
            font-size: var(--font-medium);
            opacity: 0.9;
        }

        .reasoning-toggle select {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            border: 2px solid rgba(255,255,255,0.3);
            background: var(--gent-blue-dark);
            color: white;
            font-size: var(--font-medium);
            min-height: var(--touch-min);
            cursor: pointer;
        }

        .reasoning-toggle select:focus {
            outline: 2px solid var(--gent-orange);
        }

        .powered-by {
            font-size: var(--font-small);
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .powered-by img {
            height: 20px;
        }

        .powered-by span {
            color: white;
            font-weight: 300;
        }

        .container {
            flex: 1;
            display: flex;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 1rem;
            gap: 1rem;
            overflow: hidden;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 85%;
            padding: 1.25rem;
            border-radius: 12px;
            line-height: 1.6;
            font-size: var(--font-base);
        }

        .message.user {
            background-color: var(--gent-blue);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background-color: var(--aidan-light-green);
            color: var(--text-primary);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.assistant a {
            color: var(--gent-orange);
            text-decoration: underline;
        }

        .message.assistant a:hover {
            color: var(--gent-blue);
        }

        .message.assistant pre {
            background: #d8e8e8;
            padding: 0.75rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .message.assistant ul, .message.assistant ol {
            margin-left: 1.5rem;
            margin-top: 0.5rem;
        }

        .message.assistant li {
            margin-bottom: 0.5rem;
        }

        .input-container {
            padding: 1rem;
            border-top: 1px solid #eee;
            display: flex;
            gap: 0.75rem;
        }

        #user-input {
            flex: 1;
            padding: 1rem 1.25rem;
            border: 3px solid var(--border-light);
            border-radius: 8px;
            font-size: var(--font-base);
            min-height: var(--touch-large);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #user-input:focus {
            border-color: var(--gent-orange);
            box-shadow: 0 0 0 3px rgba(243, 128, 43, 0.2);
        }

        #user-input::placeholder {
            color: #888;
            font-size: var(--font-base);
        }

        #send-btn {
            padding: 1rem 2rem;
            background-color: var(--gent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: var(--font-base);
            font-weight: 600;
            min-height: var(--touch-large);
            min-width: 120px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #send-btn:hover {
            background-color: var(--gent-blue-dark);
        }

        #send-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        #clear-btn {
            padding: 1rem;
            background-color: #f5f5f5;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1.4rem;
            min-height: var(--touch-large);
            min-width: var(--touch-large);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        #clear-btn:hover {
            background-color: var(--gent-orange-light);
            border-color: var(--gent-orange);
        }

        /* Collapsible Sidebar */
        .sidebar-container {
            display: flex;
            flex-direction: column;
        }

        .sidebar-toggle {
            display: block;
            padding: 0.75rem 1rem;
            background: white;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: var(--font-medium);
            cursor: pointer;
            margin-bottom: 0.5rem;
            min-height: var(--touch-min);
        }

        .sidebar-toggle:hover {
            background: var(--aidan-light-green);
            border-color: var(--gent-blue);
        }

        .sidebar {
            width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            display: none;
        }

        .sidebar.open {
            display: block;
        }

        .sidebar h2 {
            font-size: var(--font-base);
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .example-questions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .example-btn {
            padding: 1rem;
            background: #f5f5f5;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            font-size: var(--font-medium);
            min-height: var(--touch-large);
            transition: all 0.2s;
            width: 100%;
        }

        .example-btn:hover {
            background: var(--aidan-light-green);
            border-color: var(--gent-blue);
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #666;
            font-size: var(--font-base);
        }

        .loading-dots {
            display: flex;
            gap: 6px;
        }

        .loading-dots span {
            width: 10px;
            height: 10px;
            background: var(--gent-orange);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Responsive - adjust layout on smaller screens */
        @media (max-width: 1024px) {
            .sidebar {
                width: 100%;
            }
            .container {
                flex-direction: column;
            }
            .sidebar-container {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .message { max-width: 95%; }
            header { padding: 1rem; }
            .header-brand img { height: 40px; }
            header h1 { font-size: 24px; }
        }

        /* Trace panel (debugging) */
        .trace-panel {
            margin-top: 0.75rem;
            border-top: 1px dashed #aaa;
            padding-top: 0.5rem;
        }

        .trace-toggle {
            background: none;
            border: none;
            color: #666;
            font-size: var(--font-small);
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .trace-toggle:hover {
            color: var(--gent-blue);
        }

        .trace-content {
            display: none;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #e8e8e8;
            border-radius: 4px;
            font-size: var(--font-small);
            font-family: monospace;
        }

        .trace-content.open {
            display: block;
        }

        .trace-content .label {
            color: #666;
            font-weight: bold;
        }

        .trace-content .intents {
            margin: 0.25rem 0;
            padding-left: 1rem;
        }

        .trace-content .intents li {
            margin: 0.15rem 0;
            color: #444;
        }

        .trace-content .stats {
            margin-top: 0.5rem;
            color: #666;
        }

        .timing-bar {
            display: flex;
            gap: 1rem;
            margin: 0.25rem 0 0.5rem 0;
            font-size: 0.8rem;
        }

        .timing-item {
            padding: 3px 8px;
            background: #d0d0d0;
            border-radius: 3px;
        }

        .timing-item strong {
            color: #c44;
        }

        /* Streaming cursor shown while response is building */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: var(--gent-blue);
            margin-left: 2px;
            vertical-align: text-bottom;
            animation: blink 0.8s infinite;
        }

        /* Status text shown during search/generation phases */
        .stream-status {
            color: #888;
            font-size: var(--font-small);
            font-style: italic;
            margin-bottom: 0.25rem;
        }

        /* Feedback bar below each assistant response */
        .feedback-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }

        .feedback-btn {
            background: white;
            border: 2px solid var(--border-light);
            border-radius: 6px;
            padding: 0.4rem 0.75rem;
            font-size: 1.1rem;
            cursor: pointer;
            min-height: 40px;
            transition: all 0.15s;
            line-height: 1;
        }
        .feedback-btn:hover { border-color: var(--gent-blue); background: var(--aidan-light-green); }
        .feedback-btn.active-good { background: #d4edda; border-color: #2e7d32; }
        .feedback-btn.active-bad  { background: #ffe0e0; border-color: #c44; }
        .feedback-btn.active-flag { background: #fff3cd; border-color: #f9a825; }
        .feedback-btn.mic-recording { background: #ffe0e0; border-color: #c44; animation: blink 0.8s infinite; }

        .feedback-initials {
            width: 52px;
            padding: 0.4rem 0.5rem;
            border: 2px solid var(--border-light);
            border-radius: 6px;
            font-size: var(--font-small);
            text-align: center;
            text-transform: uppercase;
            min-height: 40px;
        }
        .feedback-initials:focus { outline: none; border-color: var(--gent-orange); }

        /* Expandable notes field when flagging */
        .flag-notes {
            display: none;
            width: 100%;
            margin-top: 0.5rem;
            gap: 0.5rem;
        }
        .flag-notes.open { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .flag-notes textarea {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--border-light);
            border-radius: 6px;
            font-size: var(--font-small);
            font-family: inherit;
            resize: vertical;
            min-height: 56px;
        }
        .flag-notes textarea:focus { outline: none; border-color: var(--gent-orange); }
        .flag-submit-btn {
            padding: 0.5rem 1rem;
            background: var(--gent-orange);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: var(--font-small);
            font-weight: 600;
            min-height: 48px;
            align-self: flex-end;
        }
        .flag-submit-btn:hover { background: #d96e1e; }
        .feedback-saved-msg {
            font-size: var(--font-small);
            color: #2e7d32;
            font-style: italic;
        }

        /* Initials input in header */
        .initials-input {
            width: 60px;
            padding: 0.4rem 0.5rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: var(--gent-blue-dark);
            color: white;
            font-size: var(--font-small);
            text-align: center;
            text-transform: uppercase;
        }
        .initials-input::placeholder { color: rgba(255,255,255,0.6); }
        .initials-input:focus { outline: none; border-color: var(--gent-orange); }
        .initials-label {
            font-size: var(--font-small);
            opacity: 0.85;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-brand">
            <img src="images/Gent-Machine-Logo-Blue-White-Text.jpg" alt="Gent Machine Company">
            <div>
                <h1>Davenport Model B Support</h1>
                <div class="subtitle">5-Spindle Automatic Screw Machine</div>
            </div>
        </div>
        <div class="header-right">
            <div class="reasoning-toggle">
                <label for="reasoning-level">Search depth:</label>
                <select id="reasoning-level">
                    <option value="fast">Fast (~10s)</option>
                    <option value="balanced">Balanced (~20s)</option>
                    <option value="thorough" selected>Thorough (~45s)</option>
                </select>
                <span class="initials-label">Your initials:</span>
                <input type="text" id="user-initials" class="initials-input"
                       placeholder="e.g. DL" maxlength="4"
                       title="Enter your initials to track your feedback">
            </div>
            <div class="powered-by">
                Powered by <img src="images/Aidan-Logo_White.png" alt="Aidan"> <span>aidan</span> systems
            </div>
        </div>
    </header>

    <div class="container">
        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="message assistant">
                    Welcome to Gent Machine Davenport support. Ask about troubleshooting, maintenance, or operation of your Model B machine.
                </div>
            </div>
            <div class="input-container">
                <input type="text" id="user-input" placeholder="Ask about your Davenport machine..." autocomplete="off">
                <button id="send-btn">Send</button>
                <button id="clear-btn" title="Clear chat and start new topic">&#128260;</button>
            </div>
        </div>

        <div class="sidebar-container">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                &#9776; Example Questions
            </button>
            <div class="sidebar" id="sidebar">
                <h2>Example Questions</h2>
                <div class="example-questions">
                    <button class="example-btn" onclick="askQuestion('What are the common causes of spindle vibration?')">
                        What are the common causes of spindle vibration?
                    </button>
                    <button class="example-btn" onclick="askQuestion('How do I adjust the stock reel tension?')">
                        How do I adjust the stock reel tension?
                    </button>
                    <button class="example-btn" onclick="askQuestion('What is the cam roll inspection procedure?')">
                        What is the cam roll inspection procedure?
                    </button>
                    <button class="example-btn" onclick="askQuestion('How do I troubleshoot chatter?')">
                        How do I troubleshoot chatter?
                    </button>
                    <button class="example-btn" onclick="askQuestion('What weekly maintenance should I perform?')">
                        What weekly maintenance should I perform?
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-btn');
        const reasoningSelect = document.getElementById('reasoning-level');
        const sidebarEl = document.getElementById('sidebar');
        const initialsInput = document.getElementById('user-initials');

        const API_BASE = 'https://func-davenport-api.azurewebsites.net/api';

        // Conversation state
        let conversationId = null;

        // Message history for feedback submission: [{message, response, reasoning_level}]
        let messageHistory = [];

        // Restore initials from localStorage (persists across sessions)
        initialsInput.value = localStorage.getItem('davenport_initials') || '';
        initialsInput.addEventListener('change', () => {
            localStorage.setItem('davenport_initials', initialsInput.value.toUpperCase());
            initialsInput.value = initialsInput.value.toUpperCase();
        });

        // Active voice recorder (if recording)
        let activeRecorder = null;

        // ---------------------------------------------------------------
        // Sidebar toggle
        // ---------------------------------------------------------------
        function toggleSidebar() {
            sidebarEl.classList.toggle('open');
        }

        // ---------------------------------------------------------------
        // Clear chat
        // ---------------------------------------------------------------
        function clearChat() {
            messagesEl.innerHTML = `<div class="message assistant">
                Welcome to Gent Machine Davenport support. Ask about troubleshooting, maintenance, or operation of your Model B machine.
            </div>`;
            conversationId = null;
            messageHistory = [];
            inputEl.focus();
        }
        clearBtn.addEventListener('click', clearChat);

        // ---------------------------------------------------------------
        // Markdown formatting â€” shared between initial render and streaming
        // ---------------------------------------------------------------
        function formatMarkdown(text) {
            // Links first (before other transforms that might corrupt URLs)
            text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            // Bold
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            // Inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Numbered lists (e.g. "1. item\n2. item")
            const startsWithNumber = /^1[).]\s/.test(text.trim());
            if (startsWithNumber) {
                const items = text.split(/[).]\s*(?=\d{1,2}[).]\s)/);
                if (items.length > 1) {
                    text = '<ol>' + items.map(item => {
                        const cleaned = item.replace(/^\d{1,2}[).]\s*/, '').trim();
                        return cleaned ? '<li>' + cleaned + '</li>' : '';
                    }).filter(x => x).join('') + '</ol>';
                    return text;
                }
            }
            // Bullet lists
            text = text.replace(/\n- /g, '</li><li>');
            // Paragraphs
            text = text.replace(/\n\n/g, '</p><p>');
            return text;
        }

        // ---------------------------------------------------------------
        // Trace panel (collapsible debug info below each response)
        // ---------------------------------------------------------------
        function buildTraceHtml(trace) {
            if (!trace || (!trace.query_intents?.length && !trace.timings)) return '';
            const traceId = 'trace-' + Date.now();
            const t = trace.timings || {};
            const duration = t.total ? (t.total / 1000).toFixed(1) + 's' : '?';
            return `
                <div class="trace-panel">
                    <button class="trace-toggle" onclick="toggleTrace('${traceId}')">
                        &#9654; ${duration} &middot; ${trace.query_intents?.length || 0} sub-queries
                    </button>
                    <div id="${traceId}" class="trace-content">
                        <div class="label">Agent: ${trace.agent || 'unknown'}</div>
                        ${trace.timings ? `
                        <div class="label">Timing:</div>
                        <div class="timing-bar">
                            ${t.total ? `<span class="timing-item"><strong>Total: ${(t.total/1000).toFixed(1)}s</strong></span>` : ''}
                        </div>` : ''}
                        ${trace.query_intents?.length > 0 ? `
                        <div class="label">Query decomposition:</div>
                        <ul class="intents">
                            ${trace.query_intents.map(q => `<li>${q}</li>`).join('')}
                        </ul>` : ''}
                        <div class="stats">
                            Sources: ${trace.sources_found || 0} |
                            Tokens: ${trace.tokens?.total || 0}
                        </div>
                    </div>
                </div>`;
        }

        function toggleTrace(id) {
            const el = document.getElementById(id);
            const btn = el.previousElementSibling;
            el.classList.toggle('open');
            btn.innerHTML = el.classList.contains('open')
                ? btn.innerHTML.replace('&#9654;', '&#9660;')
                : btn.innerHTML.replace('&#9660;', '&#9654;');
        }

        // ---------------------------------------------------------------
        // Feedback bar (added below each assistant response)
        // ---------------------------------------------------------------
        function buildFeedbackBar(msgIndex) {
            return `
                <div class="feedback-bar" id="fb-bar-${msgIndex}">
                    <button class="feedback-btn" id="fb-up-${msgIndex}"
                        onclick="submitFeedback(${msgIndex}, 'thumbs_up')" title="Helpful">&#128077;</button>
                    <button class="feedback-btn" id="fb-down-${msgIndex}"
                        onclick="submitFeedback(${msgIndex}, 'thumbs_down')" title="Not helpful">&#128078;</button>
                    <button class="feedback-btn" id="fb-flag-${msgIndex}"
                        onclick="toggleFlagNotes(${msgIndex})" title="Flag for review">&#9873; Flag</button>
                    <button class="feedback-btn" id="fb-mic-${msgIndex}"
                        onclick="toggleVoiceMemo(${msgIndex})" title="Record voice note">&#127908;</button>
                    <input type="text" class="feedback-initials" id="fb-init-${msgIndex}"
                        placeholder="Initials" maxlength="4"
                        value="${initialsInput.value}"
                        title="Your initials (optional)">
                    <span class="feedback-saved-msg" id="fb-saved-${msgIndex}" style="display:none"></span>
                </div>
                <div class="flag-notes" id="flag-notes-${msgIndex}">
                    <textarea id="flag-text-${msgIndex}"
                        placeholder="What was missing or wrong? (optional)"></textarea>
                    <button class="flag-submit-btn" onclick="submitFlag(${msgIndex})">Submit Flag</button>
                </div>`;
        }

        function showFeedbackSaved(msgIndex, text) {
            const el = document.getElementById(`fb-saved-${msgIndex}`);
            if (el) { el.textContent = text; el.style.display = 'inline'; }
        }

        function submitFeedback(msgIndex, rating) {
            const msg = messageHistory[msgIndex];
            if (!msg) return;
            const initials = document.getElementById(`fb-init-${msgIndex}`)?.value
                || initialsInput.value;

            fetch(`${API_BASE}/feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversation_id: conversationId,
                    message: msg.message,
                    response: msg.response,
                    rating,
                    initials,
                    reasoning_level: msg.reasoning_level,
                    notes: ''
                })
            }).catch(err => console.error('Feedback error:', err));

            // Visual confirmation
            document.getElementById(`fb-up-${msgIndex}`)?.classList.remove('active-good');
            document.getElementById(`fb-down-${msgIndex}`)?.classList.remove('active-bad');
            if (rating === 'thumbs_up') {
                document.getElementById(`fb-up-${msgIndex}`)?.classList.add('active-good');
                showFeedbackSaved(msgIndex, 'âœ“ Thanks!');
            } else {
                document.getElementById(`fb-down-${msgIndex}`)?.classList.add('active-bad');
                showFeedbackSaved(msgIndex, 'âœ“ Noted');
            }
        }

        function toggleFlagNotes(msgIndex) {
            const notes = document.getElementById(`flag-notes-${msgIndex}`);
            const btn = document.getElementById(`fb-flag-${msgIndex}`);
            if (notes) {
                notes.classList.toggle('open');
                btn?.classList.toggle('active-flag');
            }
        }

        function submitFlag(msgIndex) {
            const msg = messageHistory[msgIndex];
            if (!msg) return;
            const notes = document.getElementById(`flag-text-${msgIndex}`)?.value || '';
            const initials = document.getElementById(`fb-init-${msgIndex}`)?.value
                || initialsInput.value;

            fetch(`${API_BASE}/feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversation_id: conversationId,
                    message: msg.message,
                    response: msg.response,
                    rating: 'flagged',
                    initials,
                    reasoning_level: msg.reasoning_level,
                    notes
                })
            }).catch(err => console.error('Flag error:', err));

            document.getElementById(`flag-notes-${msgIndex}`)?.classList.remove('open');
            document.getElementById(`fb-flag-${msgIndex}`)?.classList.add('active-flag');
            showFeedbackSaved(msgIndex, 'âœ“ Flagged for review');
        }

        // ---------------------------------------------------------------
        // Voice memo recording
        // ---------------------------------------------------------------
        async function toggleVoiceMemo(msgIndex) {
            const btn = document.getElementById(`fb-mic-${msgIndex}`);
            if (activeRecorder && activeRecorder.state === 'recording') {
                activeRecorder.stop();
                activeRecorder = null;
                btn?.classList.remove('mic-recording');
                btn.textContent = 'ðŸŽ™';
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const recorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = async () => {
                    stream.getTracks().forEach(t => t.stop());
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    const form = new FormData();
                    form.append('audio', blob, 'memo.webm');
                    form.append('conversation_id', conversationId || '');
                    form.append('initials', initialsInput.value);
                    try {
                        await fetch(`${API_BASE}/voice-memo`, { method: 'POST', body: form });
                        showFeedbackSaved(msgIndex, 'âœ“ Voice note saved');
                    } catch (err) {
                        console.error('Voice memo upload error:', err);
                    }
                };
                recorder.start();
                activeRecorder = recorder;
                btn?.classList.add('mic-recording');
                btn.textContent = 'â¹ Stop';
                // Auto-stop after 90 seconds
                setTimeout(() => {
                    if (activeRecorder && activeRecorder.state === 'recording') {
                        activeRecorder.stop();
                        activeRecorder = null;
                        btn?.classList.remove('mic-recording');
                        btn.textContent = 'ðŸŽ™';
                    }
                }, 90000);
            } catch (err) {
                alert('Microphone not available: ' + err.message);
            }
        }

        // ---------------------------------------------------------------
        // User message display
        // ---------------------------------------------------------------
        function addUserMessage(content) {
            const div = document.createElement('div');
            div.className = 'message user';
            div.textContent = content;
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // ---------------------------------------------------------------
        // Streaming send â€” main path
        // ---------------------------------------------------------------
        async function sendMessage() {
            const message = inputEl.value.trim();
            if (!message) return;

            inputEl.value = '';
            sendBtn.disabled = true;
            addUserMessage(message);

            const reasoningLevel = reasoningSelect.value;
            const msgIndex = messageHistory.length;

            // Create the assistant message div â€” we'll stream into it
            const assistantDiv = document.createElement('div');
            assistantDiv.className = 'message assistant';
            assistantDiv.innerHTML =
                '<div class="stream-status">Searching knowledge base...</div>' +
                '<span class="streaming-cursor"></span>';
            messagesEl.appendChild(assistantDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;

            let rawText = '';

            try {
                const response = await fetch(`${API_BASE}/chat/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, conversation_id: conversationId, reasoning_level: reasoningLevel })
                });

                if (!response.ok) {
                    // Non-2xx â€” fall back to reading body as text
                    throw new Error(`Server error: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    // SSE lines are separated by double-newline
                    const parts = buffer.split('\n\n');
                    buffer = parts.pop(); // last part may be incomplete

                    for (const part of parts) {
                        const line = part.trim();
                        if (!line.startsWith('data: ')) continue;
                        let data;
                        try { data = JSON.parse(line.slice(6)); } catch { continue; }

                        if (data.type === 'session') {
                            conversationId = data.conversation_id;

                        } else if (data.type === 'status') {
                            // Show status while search / generation is running
                            assistantDiv.innerHTML =
                                `<div class="stream-status">${data.text}</div>` +
                                '<span class="streaming-cursor"></span>';

                        } else if (data.type === 'delta') {
                            // Token arrived â€” render progressively
                            rawText += data.text;
                            assistantDiv.innerHTML =
                                formatMarkdown(rawText) +
                                '<span class="streaming-cursor"></span>';
                            messagesEl.scrollTop = messagesEl.scrollHeight;

                        } else if (data.type === 'done') {
                            // Final render with YouTube URLs already transformed
                            assistantDiv.innerHTML = formatMarkdown(data.full_text);
                            // Append trace + feedback bar
                            assistantDiv.innerHTML +=
                                buildTraceHtml(data.trace) +
                                buildFeedbackBar(msgIndex);
                            // Save to history for feedback submission
                            messageHistory.push({
                                message,
                                response: data.full_text,
                                reasoning_level: reasoningLevel
                            });
                            messagesEl.scrollTop = messagesEl.scrollHeight;

                        } else if (data.type === 'error') {
                            assistantDiv.innerHTML = `<strong>Error:</strong> ${data.text}`;
                        }
                    }
                }

            } catch (err) {
                assistantDiv.innerHTML = `<strong>Error:</strong> ${err.message}`;
            }

            sendBtn.disabled = false;
            inputEl.focus();
        }

        // ---------------------------------------------------------------
        // Sidebar example questions
        // ---------------------------------------------------------------
        function askQuestion(question) {
            inputEl.value = question;
            sendMessage();
        }

        sendBtn.addEventListener('click', sendMessage);
        inputEl.addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });

        inputEl.focus();
    </script>
</body>
</html>
